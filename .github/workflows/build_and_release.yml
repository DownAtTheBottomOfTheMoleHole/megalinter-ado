name: Build and release extension

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  npm_cache: ${{ github.workspace }}/npm_cache
  pnpm_config_cache: ${{ github.workspace }}/.pnpm-store

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Install GitVersion
        if: ${{ !cancelled() }}
        uses: gittools/actions/gitversion/setup@d0139503a9321f76b4a417dfdc8aebcec24decdd # v4.2.0
        with:
          versionSpec: "6.x"
          preferLatestVersion: true

      - name: Determine Version
        if: ${{ !cancelled() }}
        uses: gittools/actions/gitversion/execute@d0139503a9321f76b4a417dfdc8aebcec24decdd # v4.2.0
        with:
          configFilePath: GitVersion.yml

      - name: Replace token in task.json
        uses: cschleiden/replace-tokens@4d5a042c84c3568b3858b7af9394923d2d5195c9 # v1
        with:
          files: "megalinter/task.json"
          tokenPrefix: "#{"
          tokenSuffix: "}#"
        env:
          task_author: ${{ secrets.TASK_AUTHOR }}
          task_description: ${{ secrets.TASK_DESCRIPTION }}
          task_friendlyname: ${{ secrets.TASK_FRIENDLYNAME }}
          task_helpmarkdown: ${{ secrets.TASK_HELPMARKDOWN }}
          task_name: ${{ secrets.TASK_NAME }}
          task_id: ${{ secrets.TASK_ID }}
          major: ${{ env.GitVersion_Major }}
          minor: ${{ env.GitVersion_Minor }}
          patch: ${{ env.GitVersion_Patch }}

      - name: Replace token in vss-extension.json
        uses: cschleiden/replace-tokens@4d5a042c84c3568b3858b7af9394923d2d5195c9 # v1
        with:
          files: "vss-extension.json"
          tokenPrefix: "#{"
          tokenSuffix: "}#"
        env:
          public_extensionId: ${{ secrets.PRIVATE_EXTENSIONID }}
          public_extensionName: ${{ secrets.PRIVATE_EXTENSIONNAME }}
          publisherId: ${{ secrets.PUBLISHERID }}
          task_id: ${{ secrets.TASK_ID }}
          task_name: ${{ secrets.TASK_NAME }}
          version: ${{ env.GitVersion_MajorMinorPatch }}

      - name: Install Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: "20.x"
          check-latest: true

      - name: Install NPM Packages
        if: ${{ !cancelled() }}
        run: npm install
        working-directory: megalinter

      - name: Build with tsc
        if: ${{ !cancelled() }}
        run: npx tsc
        working-directory: megalinter

      - name: Install tfx-cli
        if: ${{ !cancelled() }}
        run: npm install -g tfx-cli

      - name: Package Private Extension
        if: ${{ !cancelled() }}
        run: tfx extension create --manifest-globs vss-extension.json --output-path ./private-extension.vsix

      - name: Publish Private Extension
        if: ${{ !cancelled() }}
        run: |
          tfx extension publish --vsix ./private-extension.vsix --service-url https://marketplace.visualstudio.com --token ${{ secrets.AZURE_DEVOPS_EXT_PAT }} --share-with ${{ secrets.AZURE_DEVOPS_ORGS }}

  scan:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout main repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Cache pnpm packages
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: "20.x"
          check-latest: true

      - name: Authenticate with NPM
        run: echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > .npmrc
        if: steps.cache.outputs.cache-hit != 'true'

      - name: Setup pnpm
        run: |
          corepack enable
          corepack prepare pnpm@latest-9 --activate
          pnpm config set store-dir ~/.pnpm-store
        if: steps.cache.outputs.cache-hit != 'true'

      - name: Install pnpm packages
        run: pnpm install
        if: steps.cache.outputs.cache-hit != 'true'

      - name: Run Megalinter
        run: |
          git config --global user.email 'megalinter@megalinter.io'
          git config --global user.name 'Megalinter runner'
          npx mega-linter-runner -r v9 --fix --flavor security --env "MEGALINTER_CONFIG='.config/.mega-linter.yml'"
        env:
          AZURE_COMMENT_REPORTER: true
          CI: true
          DISABLE_ERRORS: true
          TF_BUILD: false
          SYSTEM_ACCESSTOKEN: ${{ secrets.GITHUB_TOKEN }}
          SYSTEM_COLLECTIONURI: ${{ github.server_url }}
          SYSTEM_TEAMPROJECT: ${{ github.repository }}
          BUILD_BUILD_ID: ${{ github.run_id }}
          BUILD_REPOSITORY_ID: ${{ github.repository }}
          MEGALINTER_CONFIG: ".config/.mega-linter.yml"
          VALIDATE_ALL_CODEBASE: false
        working-directory: ${{ github.workspace }}

      - name: Publish build artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: megalinter-reports
          path: ${{ github.workspace }}/megalinter-reports

  public_release:
    runs-on: ubuntu-latest
    needs: [build, scan]
    if: ${{ always() && needs.build.result == 'success' }}
    steps:
      - name: Checkout main repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Install GitVersion
        if: ${{ !cancelled() }}
        uses: gittools/actions/gitversion/setup@d0139503a9321f76b4a417dfdc8aebcec24decdd # v4.2.0
        with:
          versionSpec: "6.x"
          preferLatestVersion: true

      - name: Determine Version
        if: ${{ !cancelled() }}
        uses: gittools/actions/gitversion/execute@d0139503a9321f76b4a417dfdc8aebcec24decdd # v4.2.0
        with:
          configFilePath: GitVersion.yml

      - name: Replace token in task.json
        uses: cschleiden/replace-tokens@4d5a042c84c3568b3858b7af9394923d2d5195c9 # v1
        with:
          files: "megalinter/task.json"
          tokenPrefix: "#{"
          tokenSuffix: "}#"
        env:
          task_author: ${{ secrets.TASK_AUTHOR }}
          task_description: ${{ secrets.TASK_DESCRIPTION }}
          task_friendlyname: ${{ secrets.TASK_FRIENDLYNAME }}
          task_helpmarkdown: ${{ secrets.TASK_HELPMARKDOWN }}
          task_name: ${{ secrets.TASK_NAME }}
          task_id: ${{ secrets.TASK_ID }}
          major: ${{ env.GitVersion_Major }}
          minor: ${{ env.GitVersion_Minor }}
          patch: ${{ env.GitVersion_Patch }}

      - name: Replace token in vss-extension.json
        uses: cschleiden/replace-tokens@4d5a042c84c3568b3858b7af9394923d2d5195c9 # v1
        with:
          files: "vss-extension.json"
          tokenPrefix: "#{"
          tokenSuffix: "}#"
        env:
          public_extensionId: ${{ secrets.PUBLIC_EXTENSIONID }}
          public_extensionName: ${{ secrets.PUBLIC_EXTENSIONNAME }}
          publisherId: ${{ secrets.PUBLISHERID }}
          task_id: ${{ secrets.TASK_ID }}
          task_name: ${{ secrets.TASK_NAME }}
          version: ${{ env.GitVersion_MajorMinorPatch }}

      - name: Install Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: "20.x"
          check-latest: true

      - name: Install NPM Packages
        run: npm install
        working-directory: megalinter

      - name: Build with tsc
        run: npx tsc
        working-directory: megalinter

      - name: Install tfx-cli
        run: npm install -g tfx-cli

      - name: Package Public Extension
        run: tfx extension create --manifest-globs vss-extension.json

      - name: Publish Public Extension
        run: |
          tfx extension publish --manifest-globs vss-extension.json --service-url https://marketplace.visualstudio.com --token ${{ secrets.AZURE_DEVOPS_EXT_PAT }}

      - name: Install Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

      - name: Install Extension to Azure DevOps Organizations
        run: |
          IFS=',' read -ra ORGS <<< "${{ secrets.AZURE_DEVOPS_ORGS }}"
          for org in "${ORGS[@]}"; do
            echo "Installing extension to organization: $org"
            az devops configure --defaults organization="https://dev.azure.com/$org"
            az extension add --name azure-devops --allow-preview true || true
            echo ${{ secrets.AZURE_DEVOPS_PAT }} | az devops login
            az devops extension install \
              --publisher-id "${{ secrets.PUBLISHERID }}" \
              --extension-id "${{ secrets.PUBLIC_EXTENSIONID }}" \
              --org "https://dev.azure.com/$org" || echo "Extension may already be installed in $org"
          done

  new_release:
    name: "Create new tagged release"
    needs: public_release
    if: ${{ needs.public_release.result == 'success' }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@d0139503a9321f76b4a417dfdc8aebcec24decdd # v4.2.0
        with:
          versionSpec: "6.x"
          preferLatestVersion: true

      - name: Determine Version
        uses: gittools/actions/gitversion/execute@d0139503a9321f76b4a417dfdc8aebcec24decdd # v4.2.0
        with:
          configFilePath: GitVersion.yml

      - name: Bump version and push tag
        id: tag_version
        uses: mathieudutour/github-tag-action@a22cf08638b34d5badda920f9daf6e72c477b07b # v6.2
        with:
          custom_tag: ${{ env.GitVersion_SemVer }}
          create_annotated_tag: true
          fetch_all_tags: true
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tag_prefix: "v"

      - name: Create a GitHub release
        uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b # v1.20.0
        with:
          allowUpdates: true
          body: ${{ steps.tag_version.outputs.changelog }}
          discussionCategory: "General"
          generateReleaseNotes: true
          makeLatest: true
          name: Release ${{ steps.tag_version.outputs.new_tag }}
          tag: ${{ steps.tag_version.outputs.new_tag }}
