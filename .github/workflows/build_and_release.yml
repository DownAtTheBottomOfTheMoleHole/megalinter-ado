name: Build and release extension

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  npm_cache: ${{ github.workspace }}/npm_cache
  pnpm_config_cache: ${{ github.workspace }}/.pnpm-store

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Install GitVersion
        if: ${{ !cancelled() }}
        uses: gittools/actions/gitversion/setup@d0139503a9321f76b4a417dfdc8aebcec24decdd # v4.2.0
        with:
          versionSpec: "6.x"
          preferLatestVersion: true

      - name: Determine Version
        if: ${{ !cancelled() }}
        uses: gittools/actions/gitversion/execute@d0139503a9321f76b4a417dfdc8aebcec24decdd # v4.2.0
        with:
          configFilePath: GitVersion.yml

      - name: Replace token in task.json
        uses: cschleiden/replace-tokens@4d5a042c84c3568b3858b7af9394923d2d5195c9 # v1
        with:
          files: "megalinter/task.json"
          tokenPrefix: "#{"
          tokenSuffix: "}#"
        env:
          task_author: ${{ secrets.TASK_AUTHOR }}
          task_description: ${{ secrets.TASK_DESCRIPTION }}
          task_friendlyname: ${{ secrets.TASK_FRIENDLYNAME }}
          task_helpmarkdown: ${{ secrets.TASK_HELPMARKDOWN }}
          task_name: ${{ secrets.TASK_NAME }}
          task_id: ${{ secrets.TASK_ID }}
          major: ${{ env.GitVersion_Major }}
          minor: ${{ env.GitVersion_Minor }}
          patch: ${{ env.GitVersion_Patch }}

      - name: Replace token in vss-extension.json
        uses: cschleiden/replace-tokens@4d5a042c84c3568b3858b7af9394923d2d5195c9 # v1
        with:
          files: "vss-extension.json"
          tokenPrefix: "#{"
          tokenSuffix: "}#"
        env:
          public_extensionId: ${{ secrets.PRIVATE_EXTENSIONID }}
          public_extensionName: ${{ secrets.PRIVATE_EXTENSIONNAME }}
          publisherId: ${{ secrets.PUBLISHERID }}
          task_id: ${{ secrets.TASK_ID }}
          task_name: ${{ secrets.TASK_NAME }}
          version: ${{ env.GitVersion_MajorMinorPatch }}

      - name: Install Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: "20.x"
          check-latest: true

      - name: Install NPM Packages
        if: ${{ !cancelled() }}
        run: npm install
        working-directory: megalinter

      - name: Build with tsc
        if: ${{ !cancelled() }}
        run: npx tsc
        working-directory: megalinter

      - name: Install tfx-cli
        if: ${{ !cancelled() }}
        run: npm install -g tfx-cli

      - name: Package Private Extension
        if: ${{ !cancelled() }}
        run: tfx extension create --manifest-globs vss-extension.json --output-path ./private-extension.vsix

      - name: Publish Private Extension
        id: publish-private
        if: ${{ !cancelled() }}
        run: |
          tfx extension publish --vsix ./private-extension.vsix --override '{"public": false}' --service-url https://marketplace.visualstudio.com --token ${{ secrets.AZURE_DEVOPS_EXT_PAT }} --share-with ${{ secrets.AZURE_DEVOPS_ORGS }}

      # Note: Tag creation has been moved to the new_release job to ensure it only happens
      # after successful public release, not after private extension publish

  scan:
    runs-on: ubuntu-latest
    continue-on-error: true
    # Skip MegaLinter when the commit is from MegaLinter itself to prevent infinite loop
    if: "!contains(github.event.head_commit.message, '[MegaLinter]')"
    steps:
      - name: Checkout main repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Cache pnpm packages
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: "20.x"
          check-latest: true

      - name: Authenticate with NPM
        run: echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > .npmrc
        if: steps.cache.outputs.cache-hit != 'true'

      - name: Setup pnpm
        run: |
          corepack enable
          corepack prepare pnpm@latest-9 --activate
          pnpm config set store-dir ~/.pnpm-store
        if: steps.cache.outputs.cache-hit != 'true'

      - name: Install pnpm packages
        run: pnpm install
        if: steps.cache.outputs.cache-hit != 'true'

      - name: Run Megalinter
        run: |
          git config --global user.email 'megalinter@megalinter.io'
          git config --global user.name 'Megalinter runner'
          npx mega-linter-runner -r v9 --fix --flavor security
        env:
          APPLY_FIXES_EVENT: all # Apply fixes on all events
          APPLY_FIXES_MODE: pull_request # Create PR with fixes (use 'commit' for direct commits)
          AZURE_COMMENT_REPORTER: true
          CI: true
          DISABLE_ERRORS: true
          TF_BUILD: false
          SYSTEM_ACCESSTOKEN: ${{ secrets.GITHUB_TOKEN }}
          SYSTEM_COLLECTIONURI: ${{ github.server_url }}
          SYSTEM_TEAMPROJECT: ${{ github.repository }}
          BUILD_BUILD_ID: ${{ github.run_id }}
          BUILD_REPOSITORY_ID: ${{ github.repository }}
          VALIDATE_ALL_CODEBASE: false
        working-directory: ${{ github.workspace }}

      - name: Check if GITHUB_TOKEN is available
        id: check-token
        if: always()
        run: |
          if [ -n "${{ secrets.GITHUB_TOKEN }}" ]; then
            echo "token_available=true" >> $GITHUB_OUTPUT
          else
            echo "token_available=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è GITHUB_TOKEN not available. PR creation will be skipped."
            echo "This should not normally happen in GitHub Actions."
          fi

      - name: Create Pull Request with fixes
        # Create PR using GITHUB_TOKEN (organization permissions allow this)
        if: always() && steps.check-token.outputs.token_available == 'true'
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "[MegaLinter] Apply linter fixes"
          title: "[MegaLinter] üîß Automated linter fixes"
          body: |
            ## Summary

            This automated PR applies code style and linting fixes detected by MegaLinter.

            ## Motivation / Context

            MegaLinter detected issues that can be automatically fixed. This PR contains the applied fixes to maintain code quality and consistency.

            ## How Has This Been Tested?

            - Fixes were automatically applied by MegaLinter's auto-fix feature
            - All enabled linters passed after applying fixes

            ## Related Issues / PRs

            Auto-generated by MegaLinter workflow

            ## Checklist

            - [x] My code follows the style guidelines of this project
            - [x] I have performed a self-review of my own code
            - [x] I have commented my code, particularly in hard-to-understand areas
            - [x] I have made corresponding changes to the documentation
            - [x] My changes generate no new warnings
            - [x] I have added tests that prove my fix is effective or that my feature works
            - [x] New and existing unit tests pass locally with my changes
          branch: megalinter-fixes
          delete-branch: true
          labels: |
            automated
            linting
            megalinter

      - name: Publish build artifacts
        if: always() # Always publish artifacts even if scan fails
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: megalinter-reports
          path: ${{ github.workspace }}/megalinter-reports

  public_release:
    runs-on: ubuntu-latest
    needs: [build, scan]
    if: ${{ always() && needs.build.result == 'success' }}
    steps:
      - name: Checkout main repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Install GitVersion
        if: ${{ !cancelled() }}
        uses: gittools/actions/gitversion/setup@d0139503a9321f76b4a417dfdc8aebcec24decdd # v4.2.0
        with:
          versionSpec: "6.x"
          preferLatestVersion: true

      - name: Determine Version
        if: ${{ !cancelled() }}
        uses: gittools/actions/gitversion/execute@d0139503a9321f76b4a417dfdc8aebcec24decdd # v4.2.0
        with:
          configFilePath: GitVersion.yml

      - name: Replace token in task.json
        uses: cschleiden/replace-tokens@4d5a042c84c3568b3858b7af9394923d2d5195c9 # v1
        with:
          files: "megalinter/task.json"
          tokenPrefix: "#{"
          tokenSuffix: "}#"
        env:
          task_author: ${{ secrets.TASK_AUTHOR }}
          task_description: ${{ secrets.TASK_DESCRIPTION }}
          task_friendlyname: ${{ secrets.TASK_FRIENDLYNAME }}
          task_helpmarkdown: ${{ secrets.TASK_HELPMARKDOWN }}
          task_name: ${{ secrets.TASK_NAME }}
          task_id: ${{ secrets.TASK_ID }}
          major: ${{ env.GitVersion_Major }}
          minor: ${{ env.GitVersion_Minor }}
          patch: ${{ env.GitVersion_Patch }}

      - name: Replace token in vss-extension.json
        uses: cschleiden/replace-tokens@4d5a042c84c3568b3858b7af9394923d2d5195c9 # v1
        with:
          files: "vss-extension.json"
          tokenPrefix: "#{"
          tokenSuffix: "}#"
        env:
          public_extensionId: ${{ secrets.PUBLIC_EXTENSIONID }}
          public_extensionName: ${{ secrets.PUBLIC_EXTENSIONNAME }}
          publisherId: ${{ secrets.PUBLISHERID }}
          task_id: ${{ secrets.TASK_ID }}
          task_name: ${{ secrets.TASK_NAME }}
          version: ${{ env.GitVersion_MajorMinorPatch }}

      - name: Install Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: "20.x"
          check-latest: true

      - name: Install NPM Packages
        run: npm install
        working-directory: megalinter

      - name: Build with tsc
        run: npx tsc
        working-directory: megalinter

      - name: Install tfx-cli
        run: npm install -g tfx-cli

      - name: Package Public Extension
        run: tfx extension create --manifest-globs vss-extension.json

      - name: Publish Public Extension
        run: |
          tfx extension publish --manifest-globs vss-extension.json --override '{"public": true}' --service-url https://marketplace.visualstudio.com --token ${{ secrets.AZURE_DEVOPS_EXT_PAT }}

      - name: Install Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

      - name: Install Extension to Azure DevOps Organizations
        run: |
          IFS=',' read -ra ORGS <<< "${{ secrets.AZURE_DEVOPS_ORGS }}"
          for org in "${ORGS[@]}"; do
            echo "Installing extension to organization: $org"
            az devops configure --defaults organization="https://dev.azure.com/$org"
            az extension add --name azure-devops --allow-preview true || true
            echo ${{ secrets.AZURE_DEVOPS_PAT }} | az devops login
            az devops extension install \
              --publisher-id "${{ secrets.PUBLISHERID }}" \
              --extension-id "${{ secrets.PUBLIC_EXTENSIONID }}" \
              --org "https://dev.azure.com/$org" || echo "Extension may already be installed in $org"
          done

  new_release:
    name: "Create new tagged release"
    needs: public_release
    if: ${{ needs.public_release.result == 'success' }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@d0139503a9321f76b4a417dfdc8aebcec24decdd # v4.2.0
        with:
          versionSpec: "6.x"
          preferLatestVersion: true

      - name: Determine Version
        uses: gittools/actions/gitversion/execute@d0139503a9321f76b4a417dfdc8aebcec24decdd # v4.2.0
        with:
          configFilePath: GitVersion.yml

      - name: Bump version and push tag
        id: tag_version
        uses: mathieudutour/github-tag-action@a22cf08638b34d5badda920f9daf6e72c477b07b # v6.2
        with:
          custom_tag: ${{ env.GitVersion_SemVer }}
          create_annotated_tag: true
          fetch_all_tags: true
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tag_prefix: "v"

      - name: Generate Release Notes
        id: release_notes
        run: |
          echo "## What's New in ${{ steps.tag_version.outputs.new_tag }}" > release_notes.md
          echo "" >> release_notes.md
          echo "### üöÄ MegaLinter Azure DevOps Extension" >> release_notes.md
          echo "" >> release_notes.md
          echo "This release provides the MegaLinter task for Azure DevOps pipelines, enabling automated code linting and formatting across your repositories." >> release_notes.md
          echo "" >> release_notes.md
          echo "### ‚ú® Features" >> release_notes.md
          echo "- Run MegaLinter in Azure DevOps pipelines with UI-based configuration" >> release_notes.md
          echo "- Support for all MegaLinter flavors (security, javascript, python, etc.)" >> release_notes.md
          echo "- Automatic fix mode with PR creation" >> release_notes.md
          echo "- PR comment reporter for inline linting feedback" >> release_notes.md
          echo "- Docker image caching support" >> release_notes.md
          echo "" >> release_notes.md
          echo "### üì¶ Installation" >> release_notes.md
          echo "Install from the [Azure DevOps Marketplace](https://marketplace.visualstudio.com/items?itemName=${{ secrets.PUBLISHERID }}.${{ secrets.PUBLIC_EXTENSIONID }})" >> release_notes.md
          echo "" >> release_notes.md
          echo "### üìù Changelog" >> release_notes.md
          echo "${{ steps.tag_version.outputs.changelog }}" >> release_notes.md
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "" >> release_notes.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ steps.tag_version.outputs.previous_tag }}...${{ steps.tag_version.outputs.new_tag }}" >> release_notes.md

      - name: Create a GitHub release
        uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b # v1.20.0
        with:
          allowUpdates: true
          bodyFile: release_notes.md
          discussionCategory: "General"
          generateReleaseNotes: false
          makeLatest: true
          name: Release ${{ steps.tag_version.outputs.new_tag }}
          tag: ${{ steps.tag_version.outputs.new_tag }}
